<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Guru - SIALIM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .scanner-frame {
            border: 3px solid #10b981;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-hadir { background-color: #10b981; }
        .status-keluar { background-color: #f59e0b; }
        .status-tidak-hadir { background-color: #ef4444; }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-500 p-2 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">SIALIMapan</h1>
                        <p class="text-sm text-gray-600">Sistem Monitoring Kehadiran Guru</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Hari ini</p>
                    <p class="font-semibold text-gray-900" id="currentDate"></p>
                    <div class="flex items-center justify-end mt-1">
                        <div id="connectionStatus" class="flex items-center text-xs">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-1"></div>
                            <span class="text-green-600">Terhubung ke Database</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Scanner Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        Scanner QR Code
                    </h2>
                    
                    <div class="scanner-frame bg-gray-100 h-64 mb-4 flex items-center justify-center relative overflow-hidden">
                        <video id="cameraVideo" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                        <canvas id="scannerCanvas" class="absolute inset-0 w-full h-full hidden"></canvas>
                        <div class="scanner-line"></div>
                        <div id="cameraPlaceholder" class="text-center z-10">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-gray-500 text-sm">Klik "Aktifkan Kamera" untuk mulai scan QR code</p>
                        </div>
                        <div id="scanningIndicator" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white hidden">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                                <p class="text-sm">Mencari barcode...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="startCameraBtn" onclick="startCamera()" 
                                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Aktifkan Kamera
                        </button>
                        <button id="stopCameraBtn" onclick="stopCamera()" disabled
                                class="bg-red-500 hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                            </svg>
                            Matikan Kamera
                        </button>
                    </div>
                    
                    <!-- Status Display -->
                    <div id="scanStatus" class="mt-4 p-4 rounded-lg hidden">
                        <div class="flex items-center">
                            <div class="status-indicator" id="statusIndicator"></div>
                            <span id="statusText" class="font-medium"></span>
                        </div>
                        <p id="statusDetail" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-purple-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Aksi Cepat
                    </h3>
                    <div class="space-y-3">
                        <button onclick="loadTodayAttendance()" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh Data Hari Ini
                        </button>
                        <button onclick="showAttendanceReport()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Lihat Laporan
                        </button>
                        <button onclick="initializeDatabase()" 
                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                            </svg>
                            Setup Database
                        </button>
                    </div>
                </div>
            </div>

            <!-- Schedule & Monitoring -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Today's Schedule -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                            <svg class="w-6 h-6 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Jadwal Hari Ini
                            <span id="dayName" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span>
                        </h2>
                        <select id="classSelector" onchange="changeSelectedClass()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">Semua Kelas</option>
                            <optgroup label="Kelas X">
                                <option value="CLS003">Kelas X1</option>
                                <option value="CLS004">Kelas X2</option>
                                <option value="CLS005">Kelas X3</option>
                                <option value="CLS006">Kelas X4</option>
                                <option value="CLS007">Kelas X5</option>
                                <option value="CLS008">Kelas X6</option>
                                <option value="CLS009">Kelas X7</option>
                                <option value="CLS010">Kelas X8</option>
                            </optgroup>
                            <optgroup label="Kelas XI">
                                <option value="CLS001">Kelas XI1</option>
                                <option value="CLS011">Kelas XI2</option>
                                <option value="CLS012">Kelas XI3</option>
                                <option value="CLS013">Kelas XI4</option>
                                <option value="CLS014">Kelas XI5</option>
                                <option value="CLS015">Kelas XI6</option>
                                <option value="CLS016">Kelas XI7</option>
                                <option value="CLS017">Kelas XI8</option>
                            </optgroup>
                            <optgroup label="Kelas XII">
                                <option value="CLS002">Kelas XII1</option>
                                <option value="CLS018">Kelas XII2</option>
                                <option value="CLS019">Kelas XII3</option>
                                <option value="CLS020">Kelas XII4</option>
                                <option value="CLS021">Kelas XII5</option>
                                <option value="CLS022">Kelas XII6</option>
                                <option value="CLS023">Kelas XII7</option>
                                <option value="CLS024">Kelas XII8</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Jam</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Guru & Detail</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Apps Script Configuration - INTEGRATED URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx2uztmmWzBC7keXAkOI4p8XaDd6QjXfNiW5iskMhQy07jpkCpc5_oiGBbeeaB87le9/exec';
        
        // Camera and scanner variables
        let codeReader = null;
        let currentStream = null;
        let isScanning = false;
        
        // Complete teacher data from the official school database
        const teachers = {
            'TCH001': { name: 'Elis Oktavia, S.Pd', subject: 'Biologi', nip: 'elis', code: '38b' },
            'TCH002': { name: 'Wardani, S.Pd', subject: 'PJOK', nip: '.14', code: '15P' },
            'TCH003': { name: 'Yati Sumyati SR, S.Pd', subject: 'Fisika', nip: 'yati', code: '33f' },
            'TCH004': { name: 'Fenty Indrianingsih, S.Pd', subject: 'B. Inggris Tingkat Lanjut', nip: 'fenty', code: '35i' },
            'TCH005': { name: 'Chandra Wiguna Umbara, S.Pd.', subject: 'B. Inggris', nip: '.04', code: '22i' },
            'TCH006': { name: 'Wawan Setiawan, S.Pd', subject: 'Ekonomi TL', nip: '.21', code: '3e' },
            'TCH007': { name: 'M. Aditia Apriadi, S.Pd', subject: 'PJOK', nip: '.48', code: '29P' },
            'TCH008': { name: 'Yayat Maskopo, S.Pd', subject: 'Matematika Wjb/TL', nip: '.08', code: '8m' },
            'TCH009': { name: 'Eva Fitriani, S.Pd.', subject: 'PPKn', nip: '.45', code: '23n' },
            'TCH010': { name: 'Liesda Aziza Zulfiani, S.Pd', subject: 'B. Inggris Tingkat Lanjut', nip: 'eneng', code: '37i' },
            'TCH011': { name: 'Muhamad Rahadiat, S.Si.', subject: 'Kimia', nip: '.03', code: '12k' },
            'TCH012': { name: 'Hidayat Rachman, S.PdI', subject: 'PAI', nip: '.06', code: '6a' },
            'TCH013': { name: 'A. Arsam Supratman, S.Pd', subject: 'Sejarah', nip: '.09', code: '20s' },
            'TCH014': { name: 'Dewi Wulansari, S.Pd', subject: 'B. Indonesia', nip: '.42', code: '27i' },
            'TCH015': { name: 'Aan Asep Saepudin, S.Pd', subject: 'Matematika Wjb', nip: '.06', code: '18w' },
            'TCH016': { name: 'Rizka Amalia Rahmawati, S.Pd', subject: 'Kimia', nip: '.17', code: '9k' },
            'TCH017': { name: 'Rima Amaliah, S.Pd', subject: 'Sejarah', nip: '.40', code: '31j' },
            'TCH018': { name: 'Encuk Sukari, S.Pd', subject: 'B. Indonesia', nip: '.20', code: '26i' },
            'TCH019': { name: 'Endang S., S.Pd', subject: 'B. Inggris Wjb', nip: '.11', code: '19i' },
            'TCH020': { name: 'Eman Suherman, M.Pd.', subject: 'Biologi', nip: '.37', code: '25b' },
            'TCH021': { name: 'Tina Hartinah Diniati, S. Pd', subject: 'Seni Budaya', nip: '.21', code: '11s' },
            'TCH022': { name: 'Asep Arif Suryadin, S.Pd', subject: 'PPKN', nip: 'asep', code: '32n' },
            'TCH023': { name: 'Yenita Sari, SE', subject: 'PKWU', nip: 'yenita', code: '34k' },
            'TCH024': { name: 'Mulyana, S.E', subject: 'PKWU', nip: '.06', code: '21k' },
            'TCH025': { name: 'Bambang Irwandi, M.Pd.', subject: 'PJOK', nip: '.06', code: '2p' },
            'TCH026': { name: 'Elis Susanti, S.Pd', subject: 'B. Indonesia', nip: '.45', code: '28i' },
            'TCH027': { name: 'Eneng Wina, S.Pd', subject: 'Matematika Wjb/TL', nip: 'eneng', code: '36w' },
            'TCH028': { name: 'Rizalul Fikri, S.Pd.', subject: 'Geografi', nip: '.06', code: '24g' },
            'TCH029': { name: 'Misrini, S.Pd', subject: 'B. Inggris Wjb', nip: '.19', code: '17i' },
            'TCH030': { name: 'Fujiawati Suryanah H., S.Pd', subject: 'PAI', nip: '.47', code: '30p' },
            'TCH031': { name: 'Resty Dwi Asry, S.Pd', subject: 'Fisika', nip: '.02', code: '13f' },
            'TCH032': { name: 'Samsul Anam, S.Pd., M.Pd', subject: 'Kepala Sekolah', nip: '.10', code: '1' },
            'TCH033': { name: 'Suhermin, M.Pd', subject: 'Koordinator BK', nip: '.16', code: '4' },
            'TCH034': { name: 'Hj. Sunaryati, SE', subject: 'Ekonomi TL', nip: '.14', code: '5e' },
            'TCH035': { name: 'Rapiudin, S.Pd', subject: 'BK Kelas X', nip: '.16', code: '7' },
            'TCH036': { name: 'Dina Widya Erista, S.Pd.', subject: 'Geografi', nip: '.12', code: '10g' },
            'TCH037': { name: 'Ratim, S.Kom', subject: 'Informatika', nip: '.09', code: '14T' },
            'TCH038': { name: 'Indri Aprianti, S.Psi', subject: 'BK Kelas XII', nip: '.22', code: '16' }
        };

        const classes = {
            'CLS003': 'X1', 'CLS004': 'X2', 'CLS005': 'X3', 'CLS006': 'X4',
            'CLS007': 'X5', 'CLS008': 'X6', 'CLS009': 'X7', 'CLS010': 'X8',
            'CLS001': 'XI1', 'CLS011': 'XI2', 'CLS012': 'XI3', 'CLS013': 'XI4',
            'CLS014': 'XI5', 'CLS015': 'XI6', 'CLS016': 'XI7', 'CLS017': 'XI8',
            'CLS002': 'XII1', 'CLS018': 'XII2', 'CLS019': 'XII3', 'CLS020': 'XII4',
            'CLS021': 'XII5', 'CLS022': 'XII6', 'CLS023': 'XII7', 'CLS024': 'XII8'
        };

        // QR Code to Class ID mapping
        const qrCodeToClassId = {
            'ClaSsX1Cd': 'CLS003', 'ClaSsX2ffd': 'CLS004', 'ClaSsX3sd': 'CLS005', 'ClaSsX4sa': 'CLS006',
            'ClaSsX5er': 'CLS007', 'ClaSsX6ww': 'CLS008', 'ClaSsX7sh': 'CLS009', 'ClaSsX8th': 'CLS010',
            'ClaSsXI1juy': 'CLS001', 'ClaSsXI2mgh': 'CLS011', 'ClaSsXI3frt': 'CLS012', 'ClaSsXI4bg': 'CLS013',
            'ClaSsXI5Bgg': 'CLS014', 'ClaSsXI6GrtF': 'CLS015', 'ClaSsXI7GfrE': 'CLS016', 'ClaSsXI8fEr': 'CLS017',
            'ClaSsXII1GtR': 'CLS002', 'ClaSsXII2ffE': 'CLS018', 'ClaSsXII3cds': 'CLS019', 'ClaSsXII4Lok': 'CLS020',
            'ClaSsXII5Gtr': 'CLS021', 'ClaSsXII6FFD': 'CLS022', 'ClaSsXII7der': 'CLS023', 'ClaSsXII8yu': 'CLS024'
        };

        // Sample schedule data
        const currentDay = new Date().getDay();
        const rawWeeklySchedule = {
            1: [ // Monday
                { time: '08:00-08:35', teacherId: 'TCH025', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH025', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH025', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:00-08:35', teacherId: 'TCH001', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH001', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:00-08:35', teacherId: 'TCH002', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH002', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ],
            2: [ // Tuesday
                { time: '08:00-08:35', teacherId: 'TCH026', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH026', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:00-08:35', teacherId: 'TCH003', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH003', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:00-08:35', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ]
        };

        function mergeSchedule(rawSchedule) {
            const merged = [];
            let currentGroup = null;
            
            for (let i = 0; i < rawSchedule.length; i++) {
                const item = rawSchedule[i];
                
                if (currentGroup && 
                    currentGroup.teacherId === item.teacherId && 
                    currentGroup.classId === item.classId) {
                    const endTime = item.time.split('-')[1];
                    currentGroup.time = currentGroup.time.split('-')[0] + '-' + endTime;
                } else {
                    if (currentGroup) {
                        merged.push(currentGroup);
                    }
                    currentGroup = { ...item };
                }
            }
            
            if (currentGroup) {
                merged.push(currentGroup);
            }
            
            return merged;
        }

        const weeklySchedule = {};
        Object.keys(rawWeeklySchedule).forEach(day => {
            weeklySchedule[day] = mergeSchedule(rawWeeklySchedule[day]);
        });

        let allSchedule = weeklySchedule[currentDay] || weeklySchedule[1];
        let selectedClass = 'all';
        let schedule = allSchedule;

        // Apps Script Integration Functions
        async function sendToAppsScript(action, data) {
            try {
                updateConnectionStatus('connecting');
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                updateConnectionStatus('connected');
                return result;
            } catch (error) {
                console.error('Error sending to Apps Script:', error);
                updateConnectionStatus('error');
                return { success: false, message: error.toString() };
            }
        }

        async function getFromAppsScript(action, params = {}) {
            try {
                updateConnectionStatus('connecting');
                
                const url = new URL(APPS_SCRIPT_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined) {
                        url.searchParams.append(key, params[key]);
                    }
                });
                
                const response = await fetch(url.toString());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                updateConnectionStatus('connected');
                return result;
            } catch (error) {
                console.error('Error getting from Apps Script:', error);
                updateConnectionStatus('error');
                return { success: false, message: error.toString() };
            }
        }

        function updateConnectionStatus(status) {
            const statusDiv = document.getElementById('connectionStatus');
            const dot = statusDiv.querySelector('div');
            const text = statusDiv.querySelector('span');
            
            switch(status) {
                case 'connected':
                    dot.className = 'w-2 h-2 bg-green-500 rounded-full mr-1';
                    text.textContent = 'Terhubung ke Database';
                    text.className = 'text-green-600';
                    break;
                case 'connecting':
                    dot.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-1';
                    text.textContent = 'Menghubungkan...';
                    text.className = 'text-yellow-600';
                    break;
                case 'error':
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full mr-1';
                    text.textContent = 'Koneksi Bermasalah';
                    text.className = 'text-red-600';
                    break;
            }
        }

        async function initializeDatabase() {
            showLoadingModal('Menginisialisasi database...', 'Mohon tunggu, sistem sedang menyiapkan database dan data sample.');
            
            try {
                const result = await sendToAppsScript('initializeDatabase', {});
                
                if (result.success) {
                    const sampleResult = await sendToAppsScript('setupSampleData', {});
                    
                    closeLoadingModal();
                    
                    if (sampleResult.success) {
                        showStatus('success', 'Database berhasil diinisialisasi', 'Database dan data sample telah disiapkan');
                    } else {
                        showStatus('warning', 'Database diinisialisasi, tapi data sample gagal', sampleResult.message);
                    }
                } else {
                    closeLoadingModal();
                    showStatus('error', 'Gagal menginisialisasi database', result.message);
                }
            } catch (error) {
                closeLoadingModal();
                showStatus('error', 'Error inisialisasi database', error.message);
            }
        }

        async function loadTodayAttendance() {
            showLoadingModal('Memuat data kehadiran...', 'Mengambil data kehadiran hari ini dari database.');
            
            try {
                const result = await getFromAppsScript('getAttendanceStatus', {});
                
                if (result.success) {
                    result.data.forEach(attendance => {
                        const scheduleItem = allSchedule.find(s => 
                            s.teacherId === attendance.TeacherID && 
                            s.classId === attendance.ClassID
                        );
                        
                        if (scheduleItem) {
                            scheduleItem.status = attendance.Status;
                            scheduleItem.checkIn = attendance.CheckInTime;
                            scheduleItem.checkOut = attendance.CheckOutTime;
                            scheduleItem.attendanceId = attendance.AttendanceID;
                            scheduleItem.learningDescription = attendance.LearningDescription;
                        }
                    });
                    
                    changeSelectedClass();
                    
                    closeLoadingModal();
                    showStatus('success', 'Data berhasil dimuat', `${result.count} record kehadiran hari ini`);
                } else {
                    closeLoadingModal();
                    showStatus('error', 'Gagal memuat data', result.message);
                }
            } catch (error) {
                closeLoadingModal();
                showStatus('error', 'Error memuat data', error.message);
            }
        }

        async function showAttendanceReport() {
            showLoadingModal('Menyiapkan laporan...', 'Mengambil data laporan kehadiran dari database.');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const result = await getFromAppsScript('getLearningActivities', {
                    startDate: today,
                    endDate: today
                });
                
                closeLoadingModal();
                
                if (result.success) {
                    showReportModal(result.data);
                } else {
                    showStatus('error', 'Gagal memuat laporan', result.message);
                }
            } catch (error) {
                closeLoadingModal();
                showStatus('error', 'Error memuat laporan', error.message);
            }
        }

        function showLoadingModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${title}</h3>
                        <p class="text-sm text-gray-600">${message}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentLoadingModal = modal;
        }

        function closeLoadingModal() {
            if (window.currentLoadingModal) {
                document.body.removeChild(window.currentLoadingModal);
                window.currentLoadingModal = null;
            }
        }

        function showReportModal(activities) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">ðŸ“Š Laporan Kegiatan Pembelajaran Hari Ini</h3>
                        <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    ${activities.length > 0 ? `
                        <div class="space-y-4">
                            ${activities.map(activity => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h4 class="font-semibold text-gray-900">${activity.TeacherName}</h4>
                                            <p class="text-sm text-gray-600">Kelas ${activity.ClassName} - ${activity.ActivityDate}</p>
                                        </div>
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">${activity.Status}</span>
                                    </div>
                                    <div class="bg-gray-50 rounded p-3">
                                        <p class="text-sm text-gray-800">${activity.ActivityDescription}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-500">Belum ada kegiatan pembelajaran yang tercatat hari ini</p>
                        </div>
                    `}
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeReportModal()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentReportModal = modal;
        }

        function closeReportModal() {
            if (window.currentReportModal) {
                document.body.removeChild(window.currentReportModal);
                window.currentReportModal = null;
            }
        }

        function changeSelectedClass() {
            selectedClass = document.getElementById('classSelector').value;
            
            if (selectedClass === 'all') {
                schedule = allSchedule;
            } else {
                schedule = allSchedule.filter(item => item.classId === selectedClass);
            }
            
            renderSchedule();
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            renderSchedule();
            initializeBarcodeReader();
            
            setTimeout(() => {
                loadTodayAttendance();
            }, 1000);
            
            setInterval(() => {
                renderSchedule();
            }, 30000);
        });

        function initializeBarcodeReader() {
            if (typeof jsQR === 'undefined') {
                console.error('jsQR library not loaded');
                showStatus('error', 'Error Scanner', 'Library QR scanner tidak tersedia');
                return false;
            }
            return true;
        }

        async function startCamera() {
            if (!initializeBarcodeReader()) {
                showStatus('error', 'Scanner Tidak Tersedia', 'QR code reader tidak tersedia');
                return;
            }

            try {
                const videoElement = document.getElementById('cameraVideo');
                const placeholder = document.getElementById('cameraPlaceholder');
                const scanningIndicator = document.getElementById('scanningIndicator');
                const startBtn = document.getElementById('startCameraBtn');
                const stopBtn = document.getElementById('stopCameraBtn');

                placeholder.classList.add('hidden');
                scanningIndicator.classList.remove('hidden');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                currentStream = stream;
                videoElement.srcObject = stream;
                videoElement.classList.remove('hidden');
                scanningIndicator.classList.add('hidden');
                
                startBtn.disabled = true;
                startBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                startBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                stopBtn.disabled = false;
                stopBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                stopBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                
                isScanning = true;
                startBarcodeDetection();
                
                showStatus('success', 'Kamera Aktif', 'Arahkan QR code ke kamera untuk scan otomatis');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                const placeholder = document.getElementById('cameraPlaceholder');
                const scanningIndicator = document.getElementById('scanningIndicator');
                
                placeholder.classList.remove('hidden');
                scanningIndicator.classList.add('hidden');
                
                if (error.name === 'NotAllowedError') {
                    showStatus('error', 'Akses Kamera Ditolak', 'Silakan izinkan akses kamera untuk menggunakan scanner');
                } else if (error.name === 'NotFoundError') {
                    showStatus('error', 'Kamera Tidak Ditemukan', 'Tidak ada kamera yang tersedia di perangkat ini');
                } else {
                    showStatus('error', 'Error Kamera', 'Tidak dapat mengakses kamera: ' + error.message);
                }
            }
        }

        function stopCamera() {
            isScanning = false;
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            const videoElement = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            const scanningIndicator = document.getElementById('scanningIndicator');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            
            videoElement.classList.add('hidden');
            placeholder.classList.remove('hidden');
            scanningIndicator.classList.add('hidden');
            
            const canvas = document.getElementById('scannerCanvas');
            canvas.classList.add('hidden');
            
            startBtn.disabled = false;
            startBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            startBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            stopBtn.disabled = true;
            stopBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            stopBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            
            showStatus('success', 'Kamera Dimatikan', 'Scanner barcode telah dihentikan');
        }

        function startBarcodeDetection() {
            if (!isScanning || !currentStream) return;
            
            const videoElement = document.getElementById('cameraVideo');
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.classList.remove('hidden');
            
            function detectQRCode() {
                if (!isScanning || !videoElement.videoWidth || !videoElement.videoHeight) {
                    if (isScanning) {
                        setTimeout(detectQRCode, 100);
                    }
                    return;
                }
                
                try {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (qrCode && qrCode.data) {
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(
                            qrCode.location.topLeftCorner.x,
                            qrCode.location.topLeftCorner.y,
                            qrCode.location.bottomRightCorner.x - qrCode.location.topLeftCorner.x,
                            qrCode.location.bottomRightCorner.y - qrCode.location.topLeftCorner.y
                        );
                        
                        processBarcodeResult(qrCode.data);
                        return;
                    }
                        
                } catch (error) {
                    console.error('Error during QR code detection:', error);
                }
                
                if (isScanning) {
                    setTimeout(detectQRCode, 100);
                }
            }
            
            setTimeout(detectQRCode, 100);
        }

        function processBarcodeResult(barcode) {
            const wasScanning = isScanning;
            isScanning = false;
            
            processBarcodeData(barcode);
            
            setTimeout(() => {
                if (wasScanning && currentStream) {
                    isScanning = true;
                    startBarcodeDetection();
                }
            }, 2000);
        }

        function processBarcodeData(barcode) {
            if (!barcode) {
                showStatus('error', 'Kode QR tidak boleh kosong', 'Silakan aktifkan kamera dan scan kode QR');
                return;
            }
            
            showCodeNotification(barcode);
            
            const scannedQRCode = barcode.trim();
            const scannedClassId = qrCodeToClassId[scannedQRCode];
            
            if (!scannedClassId) {
                showStatus('error', 'QR Code tidak valid', `QR Code "${scannedQRCode}" tidak terdaftar dalam sistem`);
                return;
            }
            
            const scannedClassName = classes[scannedClassId];
            showTeacherSelectionDialog(scannedClassId, scannedClassName, scannedQRCode);
        }
        
        function showTeacherSelectionDialog(scannedClassId, scannedClassName, qrCode) {
            stopCamera();
            
            const teachersInClass = allSchedule
                .filter(schedule => schedule.classId === scannedClassId)
                .map(schedule => schedule.teacherId)
                .filter((teacherId, index, array) => array.indexOf(teacherId) === index);
            
            if (teachersInClass.length === 0) {
                showStatus('error', 'Tidak ada jadwal', `Tidak ada guru yang terjadwal mengajar di kelas ${scannedClassName} hari ini`);
                setTimeout(() => {
                    resetToInitialState();
                }, 3000);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pilih Nama Guru</h3>
                    <p class="text-sm text-gray-600 mb-4">QR Code kelas <strong>${scannedClassName}</strong> berhasil di-scan. Pilih nama Anda dari guru yang mengajar di kelas ini hari ini:</p>
                    <div class="space-y-2 mb-4" id="teacherList">
                        ${teachersInClass.map(teacherId => {
                            const teacher = teachers[teacherId];
                            const teacherSchedules = allSchedule.filter(s => s.teacherId === teacherId && s.classId === scannedClassId);
                            const scheduleInfo = teacherSchedules.map(s => s.time).join(', ');
                            
                            return `
                                <button onclick="processTeacherAttendance('${teacherId}', '${scannedClassId}', '${scannedClassName}', '${qrCode}')" 
                                        class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-colors">
                                    <div class="font-medium text-gray-900">${teacher.name}</div>
                                    <div class="text-sm text-gray-600">${teacher.subject}</div>
                                    <div class="text-xs text-gray-500 mt-1">Jadwal: ${scheduleInfo}</div>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="text-xs text-gray-500 mb-4 p-3 bg-blue-50 rounded-lg">
                        ðŸ’¡ <strong>Info:</strong> Hanya menampilkan guru yang memiliki jadwal mengajar di kelas ${scannedClassName} pada hari ini.
                    </div>
                    <button onclick="closeTeacherDialog()" 
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">
                        Batal
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function closeTeacherDialog() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
            
            setTimeout(() => {
                resetToInitialState();
            }, 500);
        }
        
        async function processTeacherAttendance(teacherId, scannedClassId, scannedClassName, qrCode) {
            closeTeacherDialog();
            
            try {
                showLoadingModal('Memproses absensi...', 'Mengirim data ke database, mohon tunggu...');
                
                const currentSchedule = findCurrentSchedule(teacherId, scannedClassId);
                const actionType = (currentSchedule && currentSchedule.checkIn && !currentSchedule.checkOut) ? 'checkout' : 'checkin';
                
                const result = await sendToAppsScript('processAttendance', {
                    qrCode: qrCode,
                    teacherId: teacherId,
                    type: actionType
                });
                
                closeLoadingModal();
                
                if (result.success) {
                    const teacher = teachers[teacherId];
                    
                    if (actionType === 'checkin') {
                        if (currentSchedule) {
                            currentSchedule.status = result.data.status;
                            currentSchedule.checkIn = result.data.checkInTime;
                            currentSchedule.attendanceId = result.data.attendanceId;
                        }
                        
                        if (result.data.isLate) {
                            showLateArrival(teacher, scannedClassName, result.data.checkInTime, {
                                lateMinutes: result.data.lateMinutes,
                                scheduleStart: result.data.checkInTime
                            });
                        } else {
                            showSuccess(teacher, scannedClassName, result.data.checkInTime, 'Tepat waktu');
                        }
                    } else {
                        if (currentSchedule) {
                            currentSchedule.status = 'selesai';
                            currentSchedule.checkOut = result.data.checkOutTime;
                        }
                        
                        showCheckOutSuccess(teacher, scannedClassName, result.data);
                    }
                    
                    renderSchedule();
                } else {
                    showStatus('error', 'Error Absensi', result.message);
                    
                    if (result.teacherSchedules && result.teacherSchedules.length > 0) {
                        showTeacherScheduleDialog(teachers[teacherId], result.teacherSchedules, scannedClassName);
                    }
                }
                
            } catch (error) {
                closeLoadingModal();
                console.error('Error processing attendance:', error);
                showStatus('error', 'Error', 'Gagal memproses absensi: ' + error.message);
            }
        }

        function showSuccess(teacher, className, currentTime, timeStatus) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-green-800 mb-2">âœ… BERHASIL MASUK KELAS!</h3>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <p class="text-lg font-semibold text-green-900 mb-1">${teacher.name}</p>
                            <p class="text-sm text-green-700 mb-1">Kelas: <strong>${className}</strong></p>
                            <p class="text-sm text-green-700 mb-1">Waktu Masuk: <strong>${currentTime}</strong></p>
                            <p class="text-sm text-green-700">Status: <strong>${timeStatus}</strong></p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-green-700 text-center">
                            <strong>âœ… Status:</strong> Pembelajaran dimulai dan tercatat dalam database
                        </p>
                    </div>
                    
                    <button onclick="showLearningActivityForm('${teacher.name}', '${className}', '${currentTime}', '${timeStatus}')" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Selamat Mengajar!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
            
            showStatus('success', `${teacher.name} berhasil masuk kelas`, `${className} - ${currentTime} (${timeStatus})`);
        }
        
        function showLateArrival(teacher, className, currentTime, lateInfo) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4">
                            <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-yellow-800 mb-2">âš ï¸ TERLAMBAT TAPI BERHASIL MASUK!</h3>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <p class="text-lg font-semibold text-yellow-900 mb-1">${teacher.name}</p>
                            <p class="text-sm text-yellow-700 mb-1">Kelas: <strong>${className}</strong></p>
                            <p class="text-sm text-yellow-700 mb-1">Waktu Masuk: <strong>${currentTime}</strong></p>
                            <div class="mt-2 p-2 bg-yellow-200 rounded">
                                <p class="font-bold text-yellow-900">Terlambat: ${lateInfo.lateMinutes} menit</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-700 text-center">
                            <strong>âš ï¸ Catatan:</strong> Keterlambatan tercatat dalam database. Harap lebih tepat waktu di masa mendatang.
                        </p>
                    </div>
                    
                    <button onclick="showLearningActivityForm('${teacher.name}', '${className}', '${currentTime}', 'Terlambat ${lateInfo.lateMinutes} menit')" 
                            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Mulai Mengajar
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
            
            showStatus('warning', `${teacher.name} terlambat ${lateInfo.lateMinutes} menit`, `${className} - Masuk: ${currentTime}`);
        }

        function showCheckOutSuccess(teacher, className, data) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4">
                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-blue-800 mb-2">âœ… PEMBELAJARAN SELESAI!</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p class="text-lg font-semibold text-blue-900 mb-1">${teacher.name}</p>
                            <p class="text-sm text-blue-700 mb-1">Kelas: <strong>${className}</strong></p>
                            <p class="text-sm text-blue-700 mb-1">Masuk: <strong>${data.checkInTime}</strong></p>
                            <p class="text-sm text-blue-700 mb-1">Keluar: <strong>${data.checkOutTime}</strong></p>
                            <p class="text-sm text-blue-700">Durasi: <strong>${data.duration}</strong></p>
                            ${data.wasLate ? '<p class="text-xs text-yellow-600 mt-2">âš ï¸ Catatan: Terlambat saat masuk</p>' : ''}
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-green-700 text-center">
                            <strong>âœ… Status:</strong> Data pembelajaran telah tersimpan dalam database
                        </p>
                    </div>
                    
                    <button onclick="closeSuccess()" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Selesai
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
            
            showStatus('success', `${teacher.name} selesai mengajar`, `${className} - Durasi: ${data.duration}`);
        }
        
        function showLearningActivityForm(teacherName, className, currentTime, timeStatus) {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4">
                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-blue-800 mb-2">ðŸ“ DESKRIPSI KEGIATAN PEMBELAJARAN</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p class="text-lg font-semibold text-blue-900 mb-1">${teacherName}</p>
                            <p class="text-sm text-blue-700 mb-1">Kelas: <strong>${className}</strong></p>
                            <p class="text-sm text-blue-700 mb-1">Waktu Masuk: <strong>${currentTime}</strong></p>
                            <p class="text-sm text-blue-700">Status: <strong>${timeStatus}</strong></p>
                        </div>
                    </div>
                    
                    <form onsubmit="saveLearningActivity(event, '${teacherName}', '${className}', '${currentTime}', '${timeStatus}')">
                        <div class="mb-4">
                            <label for="activityDescription" class="block text-sm font-medium text-gray-700 mb-2">
                                Deskripsi Kegiatan Pembelajaran <span class="text-red-500">*</span>
                            </label>
                            <textarea id="activityDescription" 
                                      rows="4" 
                                      required
                                      minlength="10"
                                      placeholder="Contoh: Menjelaskan materi tentang sistem persamaan linear dua variabel, memberikan contoh soal, dan latihan mandiri..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Minimal 10 karakter. Jelaskan secara singkat kegiatan pembelajaran yang akan dilakukan.</p>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                            <p class="text-xs text-yellow-700">
                                ðŸ’¡ <strong>Tips:</strong> Deskripsi ini akan tersimpan dalam database dan dapat dilihat dalam laporan kegiatan pembelajaran.
                            </p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button type="submit" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                ðŸ’¾ Simpan & Mulai Mengajar
                            </button>
                            <button type="button" onclick="skipLearningActivity('${teacherName}', '${className}')" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                â­ï¸ Lewati
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        async function saveLearningActivity(event, teacherName, className, currentTime, timeStatus) {
            event.preventDefault();
            
            const description = document.getElementById('activityDescription').value.trim();
            
            if (description.length < 10) {
                alert('Deskripsi kegiatan pembelajaran minimal 10 karakter!');
                return;
            }
            
            try {
                showLoadingModal('Menyimpan kegiatan...', 'Mengirim deskripsi pembelajaran ke database...');
                
                const teacherId = Object.keys(teachers).find(id => teachers[id].name === teacherName);
                const classId = Object.keys(classes).find(id => classes[id] === className);
                const currentSchedule = findCurrentSchedule(teacherId, classId);
                
                if (currentSchedule && currentSchedule.attendanceId) {
                    const result = await sendToAppsScript('saveLearningActivity', {
                        attendanceId: currentSchedule.attendanceId,
                        description: description,
                        materials: '',
                        method: '',
                        studentResponse: '',
                        notes: ''
                    });
                    
                    closeLoadingModal();
                    
                    if (result.success) {
                        currentSchedule.learningDescription = description;
                        
                        if (window.currentModal) {
                            document.body.removeChild(window.currentModal);
                            window.currentModal = null;
                        }
                        
                        showLearningActivitySuccess(teacherName, className, description);
                    } else {
                        alert('Error menyimpan kegiatan: ' + result.message);
                    }
                } else {
                    closeLoadingModal();
                    alert('Data absensi tidak ditemukan. Pastikan Anda sudah melakukan check-in.');
                }
                
            } catch (error) {
                closeLoadingModal();
                console.error('Error saving learning activity:', error);
                alert('Error menyimpan kegiatan: ' + error.message);
            }
        }

        function skipLearningActivity(teacherName, className) {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
            
            showStatus('success', 'Pembelajaran dimulai', `${teacherName} - ${className} (Tanpa deskripsi kegiatan)`);
            
            setTimeout(() => {
                resetToInitialState();
            }, 3000);
        }
        
        function showLearningActivitySuccess(teacherName, className, description) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-green-800 mb-2">âœ… KEGIATAN PEMBELAJARAN TERSIMPAN!</h3>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <p class="text-lg font-semibold text-green-900 mb-2">${teacherName}</p>
                            <p class="text-sm text-green-700 mb-2">Kelas: <strong>${className}</strong></p>
                            <div class="bg-white border border-green-300 rounded p-3">
                                <p class="text-xs text-gray-600 mb-1"><strong>Deskripsi Kegiatan:</strong></p>
                                <p class="text-sm text-gray-800">${description}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-green-700 text-center">
                            <strong>âœ… Berhasil:</strong> Kegiatan pembelajaran telah tersimpan dalam database dan siap untuk pembelajaran!
                        </p>
                    </div>
                    
                    <button onclick="closeSuccess()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        ðŸŽ“ Selamat Mengajar!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function showTeacherScheduleDialog(teacher, schedules, scannedClassName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Jadwal Mengajar Hari Ini</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-800 mb-2">
                            <strong>${teacher.name}</strong> tidak memiliki jadwal mengajar di <strong>Kelas ${scannedClassName}</strong> saat ini.
                        </p>
                        <p class="text-xs text-yellow-700">Berikut jadwal mengajar Anda hari ini:</p>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${schedules.map(schedule => `
                            <div class="p-3 border border-gray-200 rounded-lg">
                                <div class="text-sm font-medium text-gray-900">${schedule.time}</div>
                                <div class="text-sm text-gray-600">Kelas ${schedule.className}</div>
                                <div class="text-xs text-gray-500">${schedule.subject}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="closeTeacherDialog()" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                        Mengerti
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function closeSuccess() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
            
            setTimeout(() => {
                resetToInitialState();
            }, 1000);
        }
        
        function resetToInitialState() {
            const statusDiv = document.getElementById('scanStatus');
            statusDiv.classList.add('hidden');
            
            if (currentStream) {
                stopCamera();
            }
            
            renderSchedule();
        }
        
        function showStatus(type, title, message) {
            const statusDiv = document.getElementById('scanStatus');
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            
            statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-yellow-100', 'bg-red-100', 'border-green-200', 'border-yellow-200', 'border-red-200');
            statusText.classList.remove('text-green-800', 'text-yellow-800', 'text-red-800');
            statusDetail.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'border-green-200');
                statusText.classList.add('text-green-800');
                statusDetail.classList.add('text-green-600');
                indicator.className = 'status-indicator status-hadir';
            } else if (type === 'warning') {
                statusDiv.classList.add('bg-yellow-100', 'border-yellow-200');
                statusText.classList.add('text-yellow-800');
                statusDetail.classList.add('text-yellow-600');
                indicator.className = 'status-indicator status-keluar';
            } else {
                statusDiv.classList.add('bg-red-100', 'border-red-200');
                statusText.classList.add('text-red-800');
                statusDetail.classList.add('text-red-600');
                indicator.className = 'status-indicator status-tidak-hadir';
            }
            
            statusText.textContent = title;
            statusDetail.textContent = message;
            statusDiv.classList.add('fade-in');
            
            const hideDelay = type === 'error' ? 8000 : 5000;
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, hideDelay);
        }
        
        function showCodeNotification(code) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                    </svg>
                    <span class="text-sm">QR Code: ${code}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        
        function findCurrentSchedule(teacherId, classId) {
            return allSchedule.find(schedule => 
                schedule.teacherId === teacherId && 
                schedule.classId === classId
            );
        }
        
        function checkIfOverdue(scheduleTime, status) {
            if (status !== 'belum-dimulai') return false;
            
            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5);
            const [scheduleStart] = scheduleTime.split('-');
            
            const [currentHour, currentMinute] = currentTime.split(':').map(Number);
            const [scheduleHour, scheduleMinute] = scheduleStart.split(':').map(Number);
            
            const currentTotalMinutes = currentHour * 60 + currentMinute;
            const scheduleTotalMinutes = scheduleHour * 60 + scheduleMinute;
            
            return currentTotalMinutes > (scheduleTotalMinutes + 5);
        }
        
        function checkLateArrival(checkInTime, scheduleTime) {
            if (!checkInTime || !scheduleTime) return { isLate: false, lateMinutes: 0 };
            
            const [scheduleStart] = scheduleTime.split('-');
            const [checkInHour, checkInMinute] = checkInTime.split(':').map(Number);
            const [scheduleHour, scheduleMinute] = scheduleStart.split(':').map(Number);
            
            const checkInTotalMinutes = checkInHour * 60 + checkInMinute;
            const scheduleTotalMinutes = scheduleHour * 60 + scheduleMinute;
            
            const lateMinutes = checkInTotalMinutes - scheduleTotalMinutes;
            
            return {
                isLate: lateMinutes > 5,
                lateMinutes: Math.max(0, lateMinutes),
                scheduleStart: scheduleStart
            };
        }
        
        function getLearningDescription(teacherId, classId, status) {
            const scheduleItem = allSchedule.find(s => s.teacherId === teacherId && s.classId === classId);
            
            if (scheduleItem && scheduleItem.learningDescription) {
                return `
                    <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs">
                        <div class="font-medium text-blue-900 mb-1">ðŸ“ Kegiatan Pembelajaran:</div>
                        <div class="text-blue-800">${scheduleItem.learningDescription}</div>
                    </div>
                `;
            } else if (status === 'hadir' || status === 'terlambat') {
                return `
                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs">
                        <div class="text-yellow-800">â³ Menunggu deskripsi kegiatan pembelajaran...</div>
                    </div>
                `;
            }
            
            return '';
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
            
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const dayName = dayNames[now.getDay()];
            document.getElementById('dayName').textContent = dayName;
        }

        function renderSchedule() {
            const tbody = document.getElementById('scheduleTable');
            tbody.innerHTML = '';
            
            if (selectedClass === 'all') {
                const classSections = {};
                schedule.forEach(item => {
                    if (!classSections[item.classId]) {
                        classSections[item.classId] = [];
                    }
                    classSections[item.classId].push(item);
                });
                
                Object.keys(classSections).forEach((classId, index) => {
                    const className = classes[classId];
                    const classItems = classSections[classId];
                    
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'bg-blue-50 border-b-2 border-blue-200';
                    headerRow.innerHTML = `
                        <td colspan="3" class="py-4 px-4 text-lg font-bold text-blue-900 text-center">
                            <div class="flex items-center justify-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 7h10M7 11h10M7 15h10"></path>
                                </svg>
                                KELAS ${className}
                                <span class="ml-3 text-sm bg-blue-200 text-blue-800 px-3 py-1 rounded-full">${classItems.length} Jadwal</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(headerRow);
                    
                    classItems.forEach(item => {
                        const teacher = teachers[item.teacherId];
                        const row = document.createElement('tr');
                        
                        const isOverdue = checkIfOverdue(item.time, item.status);
                        
                        if (item.status === 'hadir') {
                            row.className = 'border-b border-gray-100 bg-green-100 hover:bg-green-150';
                        } else if (item.status === 'terlambat') {
                            row.className = 'border-b border-gray-100 bg-yellow-100 hover:bg-yellow-150';
                        } else if (item.status === 'selesai') {
                            const lateInfo = checkLateArrival(item.checkIn, item.time);
                            if (lateInfo.isLate) {
                                row.className = 'border-b border-gray-100 bg-yellow-100 hover:bg-yellow-150';
                            } else {
                                row.className = 'border-b border-gray-100 bg-green-100 hover:bg-green-150';
                            }
                        } else if (item.status === 'tidak-hadir') {
                            row.className = 'border-b border-gray-100 bg-red-100 hover:bg-red-150';
                        } else if (isOverdue) {
                            row.className = 'border-b border-gray-100 bg-red-100 hover:bg-red-150';
                        } else {
                            row.className = 'border-b border-gray-100 hover:bg-gray-50';
                        }
                        
                        let statusBadge = getStatusBadge(item.status, item.checkIn, item.time);
                        const learningDescription = getLearningDescription(item.teacherId, item.classId, item.status);
                        
                        row.innerHTML = `
                            <td class="py-3 px-4 text-sm text-gray-900 pl-8">${item.time}</td>
                            <td class="py-3 px-4">
                                <div class="text-sm font-medium text-gray-900">${teacher.name}</div>
                                <div class="text-sm text-gray-600">${teacher.subject}</div>
                                <div class="text-xs text-gray-500 mt-1">Kelas ${className}</div>
                                <div class="mt-2">${learningDescription}</div>
                            </td>
                            <td class="py-3 px-4">${statusBadge}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    if (index < Object.keys(classSections).length - 1) {
                        const spacerRow = document.createElement('tr');
                        spacerRow.innerHTML = '<td colspan="3" class="py-2"></td>';
                        tbody.appendChild(spacerRow);
                    }
                });
            } else {
                schedule.forEach(item => {
                    const teacher = teachers[item.teacherId];
                    const className = classes[item.classId];
                    
                    const row = document.createElement('tr');
                    
                    const isOverdue = checkIfOverdue(item.time, item.status);
                    
                    if (item.status === 'hadir') {
                        row.className = 'border-b border-gray-100 bg-green-100 hover:bg-green-150';
                    } else if (item.status === 'terlambat') {
                        row.className = 'border-b border-gray-100 bg-yellow-100 hover:bg-yellow-150';
                    } else if (item.status === 'selesai') {
                        const lateInfo = checkLateArrival(item.checkIn, item.time);
                        if (lateInfo.isLate) {
                            row.className = 'border-b border-gray-100 bg-yellow-100 hover:bg-yellow-150';
                        } else {
                            row.className = 'border-b border-gray-100 bg-green-100 hover:bg-green-150';
                        }
                    } else if (item.status === 'tidak-hadir') {
                        row.className = 'border-b border-gray-100 bg-red-100 hover:bg-red-150';
                    } else if (isOverdue) {
                        row.className = 'border-b border-gray-100 bg-red-100 hover:bg-red-150';
                    } else {
                        row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    }
                    
                    let statusBadge = getStatusBadge(item.status, item.checkIn, item.time);
                    const learningDescription = getLearningDescription(item.teacherId, item.classId, item.status);
                    
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm text-gray-900">${item.time}</td>
                        <td class="py-3 px-4">
                            <div class="text-sm font-medium text-gray-900">${teacher.name}</div>
                            <div class="text-sm text-gray-600">${teacher.subject}</div>
                            <div class="text-xs text-gray-500 mt-1">Kelas ${className}</div>
                            <div class="mt-2">${learningDescription}</div>
                        </td>
                        <td class="py-3 px-4">${statusBadge}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        }
        
        function getStatusBadge(status, checkIn = null, scheduleTime = null) {
            switch(status) {
                case 'hadir':
                    let hadirText = 'Sedang Mengajar';
                    if (checkIn && scheduleTime) {
                        const [scheduleStart] = scheduleTime.split('-');
                        hadirText += ` (${checkIn})`;
                    }
                    return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><span class="status-indicator status-hadir"></span>${hadirText}</span>`;
                case 'selesai':
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><span class="status-indicator bg-blue-500"></span>Selesai</span>';
                case 'terlambat':
                    let lateText = 'Terlambat';
                    if (checkIn && scheduleTime) {
                        const lateInfo = checkLateArrival(checkIn, scheduleTime);
                        lateText += ` (${lateInfo.lateMinutes} menit)`;
                    }
                    return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><span class="status-indicator status-keluar"></span>${lateText}</span>`;
                case 'tidak-hadir':
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><span class="status-indicator status-tidak-hadir"></span>Tidak Hadir</span>';
                default:
                    if (scheduleTime && checkIfOverdue(scheduleTime, status)) {
                        const now = new Date();
                        const currentTime = now.toTimeString().substring(0, 5);
                        const [scheduleStart] = scheduleTime.split('-');
                        const [currentHour, currentMinute] = currentTime.split(':').map(Number);
                        const [scheduleHour, scheduleMinute] = scheduleStart.split(':').map(Number);
                        const currentTotalMinutes = currentHour * 60 + currentMinute;
                        const scheduleTotalMinutes = scheduleHour * 60 + scheduleMinute;
                        const overdueMinutes = currentTotalMinutes - scheduleTotalMinutes;
                        
                        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><span class="status-indicator status-tidak-hadir"></span>Terlambat ${overdueMinutes} menit</span>`;
                    }
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><span class="status-indicator bg-gray-400"></span>Belum Dimulai</span>';
            }
        }

        // Test connection on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                try {
                    const result = await getFromAppsScript('testConnection');
                    if (result.success) {
                        console.log('âœ… Connected to Apps Script successfully');
                        updateConnectionStatus('connected');
                    } else {
                        console.log('âš ï¸ Apps Script connection test failed:', result.message);
                        updateConnectionStatus('error');
                    }
                } catch (error) {
                    console.log('âŒ Apps Script connection error:', error);
                    updateConnectionStatus('error');
                }
            }, 2000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                event.preventDefault();
                loadTodayAttendance();
            }
            
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                const startBtn = document.getElementById('startCameraBtn');
                if (!startBtn.disabled) {
                    startCamera();
                }
            }
            
            if (event.key === 'Escape') {
                if (window.currentModal) {
                    if (window.currentModal.querySelector('form')) {
                        return;
                    }
                    closeTeacherDialog();
                    closeSuccess();
                    closeReportModal();
                } else if (currentStream) {
                    stopCamera();
                }
            }
        });

        // Periodic sync every 5 minutes
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadTodayAttendance();
            }
        }, 5 * 60 * 1000);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                setTimeout(() => {
                    loadTodayAttendance();
                }, 1000);
            } else {
                if (currentStream) {
                    stopCamera();
                }
            }
        });

        console.log('ðŸŽ“ SIALIM - Sistem Monitoring Kehadiran Guru');
        console.log('ðŸ“± Apps Script URL:', APPS_SCRIPT_URL);
        console.log('ðŸ”§ System initialized successfully');
        console.log('âŒ¨ï¸ Keyboard shortcuts:');
        console.log('   Ctrl/Cmd + R: Refresh data');
        console.log('   Ctrl/Cmd + S: Start camera');
        console.log('   Escape: Stop camera or close modals');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a50042049f9ccb',t:'MTc1NzA2NzcwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
