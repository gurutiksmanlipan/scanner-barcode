<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Scanner Cepat (QR & Barcode)</title>
<style>
  :root { --accent:#2563eb; --ok:#16a34a; --bg:#0b1120; --card:#0f172a; --muted:#94a3b8; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:#e2e8f0}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .toolbar > *{padding:10px 12px;border-radius:10px;border:1px solid #233049;background:#0b1222;color:#dbeafe}
  button{cursor:pointer}
  button.primary{background:var(--accent);border-color:#1d4ed8;color:white;font-weight:600}
  button.good{background:var(--ok);border-color:#15803d;color:white}
  button:disabled{opacity:.5;cursor:not-allowed}
  select, .pill{min-height:40px}
  .pill{display:flex;gap:6px;align-items:center}
  .frame{position:relative;aspect-ratio:16/9;max-height:70vh;border-radius:16px;overflow:hidden;border:2px solid #1f2a44;background:#0b1222}
  video{width:100%;height:100%;object-fit:cover}
  canvas{display:none}
  .guide{
    position:absolute;inset:0;pointer-events:none;
    outline:200vmax solid rgba(0,0,0,.35);
    border:2px solid rgba(255,255,255,.6); border-radius:14px;
    width:min(75%,560px);height:min(60%,360px);margin:auto;
    box-shadow:0 0 0 200vmax rgba(0,0,0,.35);
  }
  .line{position:absolute;left:12.5%;right:12.5%;height:2px;background:rgba(59,130,246,.85);top:20%;
    animation:scan 2.2s linear infinite}
  @keyframes scan{0%{top:20%}100%{top:80%}}
  .status{margin-top:10px;font-size:14px;color:var(--muted)}
  .result{margin-top:12px;padding:12px;border-radius:12px;background:#102036;border:1px solid #1f2a44}
  .result b{color:#fff}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b6b3a;color:#dcfce7;margin-left:8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:8px 0 12px">üîé Scanner Cepat ‚Äî QR & Barcode</h1>

  <div class="toolbar">
    <button id="btnStart" class="primary">‚ñ∂Ô∏è Start</button>
    <button id="btnStop">‚èπÔ∏è Stop</button>
    <button id="btnTorch" disabled>üí° Torch</button>
    <label class="pill" title="Pilih kamera">
      üì∑
      <select id="cameraSelect"></select>
    </label>
    <label class="pill" title="Mode cepat (crop tengah + throttle)">
      ‚ö°
      <select id="speedMode">
        <option value="fast" selected>Fast</option>
        <option value="full">Full Frame</option>
      </select>
    </label>
  </div>

  <div class="frame" id="frame">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div class="guide"><div class="line"></div></div>
  </div>

  <div class="status" id="status">Siap. Klik Start untuk mulai.</div>

  <div class="result" id="result" hidden>
    <div>Terbaca: <b id="text">‚Äî</b> <span id="format" class="badge"></span></div>
    <div style="margin-top:6px;font-size:13px;color:#9fb3c8">Tap & tahan untuk salin.</div>
  </div>
</div>

<!-- ZXing fallback (multi format) -->
<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
(async function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d',{willReadFrequently:true});
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnTorch = document.getElementById('btnTorch');
  const selCam = document.getElementById('cameraSelect');
  const statusEl = document.getElementById('status');
  const speedMode = document.getElementById('speedMode');
  const resultBox = document.getElementById('result');
  const textEl = document.getElementById('text');
  const fmtEl = document.getElementById('format');

  let stream, track, imageCapture, usingTorch=false, running=false, rafId=null;
  let lastValue='', lastTime=0;
  let detector = null; // BarcodeDetector jika ada
  const hasBarcodeDetector = 'BarcodeDetector' in window;

  // Inisialisasi detector native bila ada
  if (hasBarcodeDetector) {
    try {
      const formats = ['qr_code','code_128','code_39','code_93','ean_13','ean_8','upc_a','upc_e','itf','pdf417','aztec','data_matrix'];
      detector = new window.BarcodeDetector({ formats });
      console.log('BarcodeDetector aktif dengan format:', formats);
    } catch(e){ console.warn('BarcodeDetector init gagal:', e); }
  }

  // ZXing fallback (lebih banyak format, cepat juga)
  const { BrowserMultiFormatReader, NotFoundException } = ZXingBrowser;
  const zxing = new BrowserMultiFormatReader();

  // Enumerasi kamera
  async function populateCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      selCam.innerHTML='';
      cams.forEach((c,i)=>{
        const opt = document.createElement('option');
        opt.value = c.deviceId;
        opt.textContent = c.label || `Kamera ${i+1}`;
        selCam.appendChild(opt);
      });
      if (cams.length===0) selCam.innerHTML='<option>‚Äî tidak ada kamera ‚Äî</option>';
    }catch(e){ console.warn(e); }
  }

  // Start kamera + loop scan
  async function start(){
    if (running) return;
    running = true;
    status('Meminta izin kamera‚Ä¶');
    // Prefer back camera
    const constraints = {
      video: {
        deviceId: selCam.value ? { exact: selCam.value } : undefined,
        facingMode: selCam.value ? undefined : { ideal: 'environment' },
        width: { ideal: 1920 },
        height:{ ideal: 1080 },
        focusMode: 'continuous',
        frameRate: { ideal: 30, max: 60 },
        advanced: [{ focusMode: 'continuous' }]
      },
      audio:false
    };
    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      track = stream.getVideoTracks()[0];
      // Torch support
      const caps = track.getCapabilities?.() || {};
      if (caps.torch) {
        imageCapture = new ImageCapture(track);
        btnTorch.disabled = false;
      } else {
        btnTorch.disabled = true;
      }
      await populateCameras(); // refresh labels setelah izin
      status('Kamera aktif. Memindai‚Ä¶');
      loop();
    }catch(e){
      status('Gagal akses kamera: ' + e.message);
      running = false;
    }
  }

  function stop(){
    running = false;
    cancelAnimationFrame(rafId);
    if (stream){ stream.getTracks().forEach(t=>t.stop()); }
    stream = null; track=null; imageCapture=null; usingTorch=false;
    btnTorch.disabled = true;
    status('Stopped.');
  }

  async function toggleTorch(){
    if (!track) return;
    try{
      usingTorch = !usingTorch;
      await track.applyConstraints({ advanced: [{ torch: usingTorch }] });
      btnTorch.textContent = usingTorch ? 'üí° Torch ON' : 'üí° Torch';
    }catch(e){
      console.warn('Torch gagal:', e);
      status('Torch tidak didukung di perangkat ini.');
    }
  }

  function status(msg){ statusEl.textContent = msg; }

  // Crop area (FAST MODE): 70% width x 50% height di tengah
  function getCropRect(w,h){
    const mode = speedMode.value;
    if (mode==='full') return {x:0,y:0,w,h};
    const cw = Math.round(w*0.72);
    const ch = Math.round(h*0.52);
    const cx = Math.round((w-cw)/2);
    const cy = Math.round((h-ch)/2);
    return {x:cx,y:cy,w:cw,h:ch};
  }

  // Dedup 1.2s
  function shouldEmit(val){
    const now = performance.now();
    if (val && val===lastValue && (now - lastTime) < 1200) return false;
    lastValue = val; lastTime = now; return true;
  }

  function showResult(val, fmt){
    if (!val) return;
    if (!shouldEmit(val)) return;
    textEl.textContent = val;
    fmtEl.textContent = fmt || 'UNKNOWN';
    resultBox.hidden = false;
    // haptic/beep ringan
    try{ navigator.vibrate?.(60); }catch{}
    beep();
    status('Terbaca.');
  }

  // Beep sederhana
  function beep(){
    try{
      const ctxA = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctxA.createOscillator(); const g = ctxA.createGain();
      o.type='sine'; o.frequency.setValueAtTime(880, ctxA.currentTime);
      g.gain.setValueAtTime(0.001, ctxA.currentTime);
      o.connect(g).connect(ctxA.destination);
      g.gain.exponentialRampToValueAtTime(0.3, ctxA.currentTime+0.01);
      o.start(); o.stop(ctxA.currentTime+0.08);
    }catch{}
  }

  // Loop scan
  async function loop(){
    if (!running || !video.videoWidth){ rafId = requestAnimationFrame(loop); return; }
    const vw = video.videoWidth, vh = video.videoHeight;
    const {x,y,w,h} = getCropRect(vw,vh);

    // Resize canvas tepat (hemat copy)
    if (canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    ctx.drawImage(video, x, y, w, h, 0, 0, w, h);

    try{
      if (detector){
        // BarcodeDetector ‚Äî super cepat
        const bitmap = await createImageBitmap(canvas.transferToImageBitmap ? canvas.transferToImageBitmap() : canvas);
        const codes = await detector.detect(bitmap);
        if (codes && codes.length){
          const c = codes[0];
          showResult(c.rawValue || c.rawValue, c.format);
        }
      } else {
        // ZXing fallback
        const luminance = ctx.getImageData(0,0,w,h);
        try{
          const res = await zxing.decodeBitmap(luminance);
          if (res?.text){
            showResult(res.text, res.barcodeFormat?.toString?.() || 'ZXING');
          }
        }catch(e){
          if (!(e instanceof NotFoundException)) console.debug('ZXing:', e);
        }
      }
    }catch(e){ console.debug('detect error:', e); }

    // Throttle: fast= ~30‚Äì40fps (rAF), full= ~20fps (sleep 30ms)
    if (speedMode.value==='full'){
      setTimeout(()=>{ rafId = requestAnimationFrame(loop); }, 30);
    } else {
      rafId = requestAnimationFrame(loop);
    }
  }

  // UI events
  btnStart.onclick = start;
  btnStop.onclick = stop;
  btnTorch.onclick = toggleTorch;
  selCam.onchange = async ()=>{ if (running){ stop(); await start(); } };
  speedMode.onchange = ()=>{ /* otomatis terapkan di frame berikutnya */ };

  // copy on long press (mobile)
  let pressTimer;
  document.getElementById('result').addEventListener('touchstart', ()=>{
    pressTimer = setTimeout(()=>{
      navigator.clipboard?.writeText(textEl.textContent||'');
      status('Disalin ke clipboard.');
    }, 500);
  });
  document.getElementById('result').addEventListener('touchend', ()=> clearTimeout(pressTimer));
  document.getElementById('result').addEventListener('click', ()=>{
    navigator.clipboard?.writeText(textEl.textContent||'');
    status('Disalin ke clipboard.');
  });

  // pre-populate camera list (tanpa label), lalu update setelah izin
  await populateCameras();

  // Tips iOS: harus user-gesture untuk play video
  // optional: auto start jika di HTTPS dan user pernah memberi izin
})();
</script>
</body>
</html>
