<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Guru - EduTrack V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .scanner-frame {
            border: 3px solid #10b981;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-hadir { background-color: #10b981; }
        .status-keluar { background-color: #f59e0b; }
        .status-tidak-hadir { background-color: #ef4444; }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-500 p-2 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">EduTrack</h1>
                        <p class="text-sm text-gray-600">Sistem Monitoring Kehadiran Guru</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Hari ini</p>
                    <p class="font-semibold text-gray-900" id="currentDate"></p>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Scanner Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        Scanner QR Code
                    </h2>
                    
                    <div class="scanner-frame bg-gray-100 h-64 mb-4 flex items-center justify-center relative overflow-hidden">
                        <video id="cameraVideo" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                        <canvas id="scannerCanvas" class="absolute inset-0 w-full h-full hidden"></canvas>
                        <div class="scanner-line"></div>
                        <div id="cameraPlaceholder" class="text-center z-10">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-gray-500 text-sm">Klik tombol untuk mengaktifkan kamera</p>
                        </div>
                        <div id="scanningIndicator" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white hidden">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                                <p class="text-sm">Mencari barcode...</p>
                            </div>
                        </div>
                    </div>
                    
                    <input type="text" id="barcodeInput" placeholder="Atau ketik kode QR..." 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="startCameraBtn" onclick="startCamera()" 
                                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Aktifkan Kamera
                        </button>
                        <button id="stopCameraBtn" onclick="stopCamera()" disabled
                                class="bg-red-500 hover:bg-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                            </svg>
                            Matikan Kamera
                        </button>
                    </div>
                    
                    <button onclick="processManualBarcode()" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Proses Manual
                    </button>
                    
                    <!-- Status Display -->
                    <div id="scanStatus" class="mt-4 p-4 rounded-lg hidden">
                        <div class="flex items-center">
                            <div class="status-indicator" id="statusIndicator"></div>
                            <span id="statusText" class="font-medium"></span>
                        </div>
                        <p id="statusDetail" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- Schedule & Monitoring -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Today's Schedule -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                            <svg class="w-6 h-6 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Jadwal Hari Ini
                            <span id="dayName" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span>
                        </h2>
                        <select id="classSelector" onchange="changeSelectedClass()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">Semua Kelas</option>
                            <option value="CLS003">Kelas X1</option>
                            <option value="CLS001">Kelas XI1</option>
                            <option value="CLS002">Kelas XII1</option>
                        </select>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Jam</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Guru</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Mata Pelajaran</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Kelas</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>
        // Camera and scanner variables
        let codeReader = null;
        let currentStream = null;
        let isScanning = false;
        
        // Complete teacher data from the schedule
        const teachers = {
            'TCH001': { name: 'Elis Oktavia, S.Pd', subject: 'Biologi' },
            'TCH002': { name: 'Wardani, S.Pd', subject: 'PJOK' },
            'TCH003': { name: 'Yati Sumyati SR, S.Pd', subject: 'Fisika' },
            'TCH004': { name: 'Fenty Indrianingsih, S.Pd', subject: 'B. Inggris Tingkat Lanjut' },
            'TCH005': { name: 'Chandra Wiguna Umbara, S.Pd.', subject: 'B. Inggris' },
            'TCH006': { name: 'Wawan Setiawan, S.Pd', subject: 'Ekonomi TL' },
            'TCH007': { name: 'M. Aditia Apriadi, S.Pd', subject: 'PJOK' },
            'TCH008': { name: 'Yayat Maskopo, S.Pd', subject: 'Matematika Wjb/TL' },
            'TCH009': { name: 'Eva Fitriani, S.Pd.', subject: 'PPKn' },
            'TCH010': { name: 'Liesda Aziza Zulfiani, S.Pd', subject: 'B. Inggris Tngkat Lanjut' },
            'TCH011': { name: 'Muhamad Rahadiat, S.Si.', subject: 'Kimia' },
            'TCH012': { name: 'Hidayat Rachman, S.PdI', subject: 'PAI' },
            'TCH013': { name: 'A. Arsam Supratman, S.Pd', subject: 'Sejarah' },
            'TCH014': { name: 'Dewi Wulansari, S.Pd', subject: 'B. Indonesia' },
            'TCH015': { name: 'Aan Asep Saepudin, S.Pd', subject: 'Matematika Wjb' },
            'TCH016': { name: 'Rizka Amalia Rahmawati, S.Pd', subject: 'Kimia' },
            'TCH017': { name: 'Rima Amaliah, S.Pd', subject: 'Sejarah' },
            'TCH018': { name: 'Encuk Sukari, S.Pd', subject: 'B. Indonesia' },
            'TCH019': { name: 'Endang S., S.Pd', subject: 'B. Inggris Wjb' },
            'TCH020': { name: 'Eman Suherman, M.Pd.', subject: 'Biologi' },
            'TCH021': { name: 'Tina Hartinah Diniati, S. Pd', subject: 'Seni Budaya' },
            'TCH022': { name: 'Asep Arif Suryadin, S.Pd', subject: 'PPKN' },
            'TCH023': { name: 'Yenita Sari, SE', subject: 'PKWU' },
            'TCH024': { name: 'Mulyana, S.E', subject: 'PKWU' },
            'TCH025': { name: 'Bambang Irwandi, M.Pd.', subject: 'PJOK' },
            'TCH026': { name: 'Elis Susanti, S.Pd', subject: 'B. Indonesia' },
            'TCH027': { name: 'Eneng Wina, S.Pd', subject: 'Matematika Wjb/TL' },
            'TCH028': { name: 'Rizalul Fikri, S.Pd.', subject: 'Geografi' },
            'TCH029': { name: 'Misrini, S.Pd', subject: 'B. Inggris Wjb' },
            'TCH030': { name: 'Fujiawati Suryanah H., S.Pd', subject: 'PAI' },
            'TCH031': { name: 'Resty Dwi Asry, S.Pd', subject: 'Fisika' }
        };

        const classes = {
            'CLS003': 'X1',
            'CLS001': 'XI1',
            'CLS002': 'XII1'
        };

        // Get current day for dynamic schedule
        const currentDay = new Date().getDay(); // 0=Sunday, 1=Monday, etc.
        
        // Complete weekly schedule for all classes (raw data)
        const rawWeeklySchedule = {
            1: [ // Monday - X1, XI1 & XII1
                // X1 Schedule
                { time: '08:00-08:35', teacherId: 'TCH025', classId: 'CLS003', status: 'hadir', checkIn: '08:00', checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH025', classId: 'CLS003', status: 'hadir', checkIn: '08:35', checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH025', classId: 'CLS003', status: 'hadir', checkIn: '09:10', checkOut: null },
                { time: '09:45-10:20', teacherId: 'TCH013', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:50-11:25', teacherId: 'TCH013', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:25-12:00', teacherId: 'TCH013', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH016', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH016', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH016', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XI1 Schedule
                { time: '08:00-08:35', teacherId: 'TCH001', classId: 'CLS001', status: 'hadir', checkIn: '08:02', checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH001', classId: 'CLS001', status: 'hadir', checkIn: '08:35', checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH005', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:45-10:20', teacherId: 'TCH005', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:50-11:25', teacherId: 'TCH008', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:25-12:00', teacherId: 'TCH008', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH010', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH010', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH010', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XII1 Schedule
                { time: '08:00-08:35', teacherId: 'TCH002', classId: 'CLS002', status: 'hadir', checkIn: '08:00', checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH002', classId: 'CLS002', status: 'hadir', checkIn: '08:35', checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH002', classId: 'CLS002', status: 'hadir', checkIn: '09:10', checkOut: null },
                { time: '09:45-10:20', teacherId: 'TCH006', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:50-11:25', teacherId: 'TCH009', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:25-12:00', teacherId: 'TCH009', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH011', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH011', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH011', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ],
            2: [ // Tuesday - X1, XI1 & XII1
                // X1 Schedule
                { time: '08:00-08:35', teacherId: 'TCH026', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH026', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH027', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:45-10:20', teacherId: 'TCH027', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:50-11:25', teacherId: 'TCH001', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:25-12:00', teacherId: 'TCH001', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH028', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH028', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH028', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XI1 Schedule
                { time: '08:00-08:35', teacherId: 'TCH003', classId: 'CLS001', status: 'terlambat', checkIn: '08:05', checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH003', classId: 'CLS001', status: 'hadir', checkIn: '08:35', checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH003', classId: 'CLS001', status: 'hadir', checkIn: '09:10', checkOut: null },
                { time: '09:45-10:20', teacherId: 'TCH007', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:50-11:25', teacherId: 'TCH007', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:25-12:00', teacherId: 'TCH007', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH012', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH012', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH012', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XII1 Schedule
                { time: '08:00-08:35', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:10', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:10-09:45', teacherId: 'TCH005', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:45-10:20', teacherId: 'TCH005', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:50-11:25', teacherId: 'TCH015', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:25-12:00', teacherId: 'TCH015', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH013', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH013', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH014', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ],
            3: [ // Wednesday - X1, XI1 & XII1
                // X1 Schedule
                { time: '07:15-07:50', teacherId: 'TCH026', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:50-08:25', teacherId: 'TCH026', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:25-09:00', teacherId: 'TCH017', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:00-09:35', teacherId: 'TCH017', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:05-10:40', teacherId: 'TCH017', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:40-11:15', teacherId: 'TCH029', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:15-11:50', teacherId: 'TCH029', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH030', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH030', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH030', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XI1 Schedule
                { time: '07:15-07:50', teacherId: 'TCH003', classId: 'CLS001', status: 'tidak-hadir', checkIn: null, checkOut: null },
                { time: '07:50-08:25', teacherId: 'TCH003', classId: 'CLS001', status: 'tidak-hadir', checkIn: null, checkOut: null },
                { time: '08:25-09:00', teacherId: 'TCH010', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:00-09:35', teacherId: 'TCH010', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:05-10:40', teacherId: 'TCH016', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:40-11:15', teacherId: 'TCH016', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:15-11:50', teacherId: 'TCH017', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH017', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH018', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH018', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XII1 Schedule
                { time: '07:15-07:50', teacherId: 'TCH015', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:50-08:25', teacherId: 'TCH015', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:25-09:00', teacherId: 'TCH011', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:00-09:35', teacherId: 'TCH011', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:05-10:40', teacherId: 'TCH012', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:40-11:15', teacherId: 'TCH012', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:15-11:50', teacherId: 'TCH012', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH019', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH019', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH020', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ],
            4: [ // Thursday - X1, XI1 & XII1
                // X1 Schedule
                { time: '07:15-07:50', teacherId: 'TCH023', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:50-08:25', teacherId: 'TCH023', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:25-09:00', teacherId: 'TCH023', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:00-09:35', teacherId: 'TCH022', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:05-10:40', teacherId: 'TCH022', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:40-11:15', teacherId: 'TCH031', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:15-11:50', teacherId: 'TCH031', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH003', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH003', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH003', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XI1 Schedule
                { time: '07:15-07:50', teacherId: 'TCH021', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:50-08:25', teacherId: 'TCH021', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:25-09:00', teacherId: 'TCH008', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:00-09:35', teacherId: 'TCH008', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:05-10:40', teacherId: 'TCH001', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:40-11:15', teacherId: 'TCH005', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:15-11:50', teacherId: 'TCH018', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH018', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH016', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH016', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XII1 Schedule
                { time: '07:15-07:50', teacherId: 'TCH019', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:50-08:25', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:25-09:00', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:00-09:35', teacherId: 'TCH004', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:05-10:40', teacherId: 'TCH006', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:40-11:15', teacherId: 'TCH006', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '11:15-11:50', teacherId: 'TCH014', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '12:50-13:25', teacherId: 'TCH014', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '13:25-14:00', teacherId: 'TCH020', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '14:00-14:35', teacherId: 'TCH020', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ],
            5: [ // Friday - X1, XI1 & XII1
                // X1 Schedule
                { time: '07:05-07:35', teacherId: 'TCH027', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:35-08:05', teacherId: 'TCH027', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:05-08:35', teacherId: 'TCH031', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:05', teacherId: 'TCH029', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:15-09:45', teacherId: 'TCH021', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:45-10:15', teacherId: 'TCH021', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:15-10:45', teacherId: 'TCH024', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:45-11:15', teacherId: 'TCH024', classId: 'CLS003', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XI1 Schedule
                { time: '07:05-07:35', teacherId: 'TCH022', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:35-08:05', teacherId: 'TCH022', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:05-08:35', teacherId: 'TCH023', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:05', teacherId: 'TCH023', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:15-09:45', teacherId: 'TCH001', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:45-10:15', teacherId: 'TCH001', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:15-10:45', teacherId: 'TCH016', classId: 'CLS001', status: 'belum-dimulai', checkIn: null, checkOut: null },
                // XII1 Schedule
                { time: '07:05-07:35', teacherId: 'TCH024', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '07:35-08:05', teacherId: 'TCH024', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:05-08:35', teacherId: 'TCH020', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '08:35-09:05', teacherId: 'TCH020', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:15-09:45', teacherId: 'TCH014', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '09:45-10:15', teacherId: 'TCH006', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null },
                { time: '10:15-10:45', teacherId: 'TCH006', classId: 'CLS002', status: 'belum-dimulai', checkIn: null, checkOut: null }
            ]
        };

        // Function to merge consecutive same teacher schedules
        function mergeSchedule(rawSchedule) {
            const merged = [];
            let currentGroup = null;
            
            for (let i = 0; i < rawSchedule.length; i++) {
                const item = rawSchedule[i];
                
                if (currentGroup && 
                    currentGroup.teacherId === item.teacherId && 
                    currentGroup.classId === item.classId) {
                    // Same teacher and class, extend the time range
                    const endTime = item.time.split('-')[1];
                    currentGroup.time = currentGroup.time.split('-')[0] + '-' + endTime;
                    
                    // Update status - prioritize active statuses
                    if (item.status === 'hadir' || currentGroup.status === 'hadir') {
                        currentGroup.status = 'hadir';
                    } else if (item.status === 'terlambat' || currentGroup.status === 'terlambat') {
                        currentGroup.status = 'terlambat';
                    } else if (item.status === 'tidak-hadir' || currentGroup.status === 'tidak-hadir') {
                        currentGroup.status = 'tidak-hadir';
                    }
                    
                    // Keep earliest checkIn and latest checkOut
                    if (item.checkIn && !currentGroup.checkIn) {
                        currentGroup.checkIn = item.checkIn;
                    }
                    if (item.checkOut) {
                        currentGroup.checkOut = item.checkOut;
                    }
                } else {
                    // Different teacher or class, start new group
                    if (currentGroup) {
                        merged.push(currentGroup);
                    }
                    currentGroup = { ...item };
                }
            }
            
            // Add the last group
            if (currentGroup) {
                merged.push(currentGroup);
            }
            
            return merged;
        }

        // Process and merge schedules
        const weeklySchedule = {};
        Object.keys(rawWeeklySchedule).forEach(day => {
            weeklySchedule[day] = mergeSchedule(rawWeeklySchedule[day]);
        });

        // Get today's schedule or default to Monday if weekend
        let allSchedule = weeklySchedule[currentDay] || weeklySchedule[1];
        let selectedClass = 'all';
        let schedule = allSchedule;

        let activities = [
            { time: '08:02', teacher: 'Elis Oktavia, S.Pd', action: 'masuk', class: 'XI1' },
            { time: '08:35', teacher: 'Elis Oktavia, S.Pd', action: 'masuk', class: 'XI1' },
            { time: '08:00', teacher: 'Wardani, S.Pd', action: 'masuk', class: 'XII1' },
            { time: '08:35', teacher: 'Wardani, S.Pd', action: 'masuk', class: 'XII1' },
            { time: '09:10', teacher: 'Wardani, S.Pd', action: 'masuk', class: 'XII1' }
        ];

        // Function to change selected class
        function changeSelectedClass() {
            selectedClass = document.getElementById('classSelector').value;
            
            if (selectedClass === 'all') {
                schedule = allSchedule;
            } else {
                schedule = allSchedule.filter(item => item.classId === selectedClass);
            }
            
            renderSchedule();
            updateStats();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            renderSchedule();
            
            // Auto-focus barcode input
            document.getElementById('barcodeInput').focus();
            
            // Handle Enter key in barcode input
            document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processManualBarcode();
                }
            });
            
            // Initialize barcode reader
            initializeBarcodeReader();
        });

        function initializeBarcodeReader() {
            // jsQR doesn't need initialization, just check if it's available
            if (typeof jsQR === 'undefined') {
                console.error('jsQR library not loaded');
                showStatus('error', 'Error Scanner', 'Library QR scanner tidak tersedia');
                return false;
            }
            return true;
        }

        async function startCamera() {
            if (!initializeBarcodeReader()) {
                showStatus('error', 'Scanner Tidak Tersedia', 'QR code reader tidak tersedia');
                return;
            }

            try {
                const videoElement = document.getElementById('cameraVideo');
                const placeholder = document.getElementById('cameraPlaceholder');
                const scanningIndicator = document.getElementById('scanningIndicator');
                const startBtn = document.getElementById('startCameraBtn');
                const stopBtn = document.getElementById('stopCameraBtn');

                // Show loading indicator
                placeholder.classList.add('hidden');
                scanningIndicator.classList.remove('hidden');
                
                // Request camera permission and start scanning
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Use back camera if available
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                currentStream = stream;
                videoElement.srcObject = stream;
                videoElement.classList.remove('hidden');
                scanningIndicator.classList.add('hidden');
                
                // Update button states
                startBtn.disabled = true;
                startBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                startBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                stopBtn.disabled = false;
                stopBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                stopBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                
                // Start barcode detection
                isScanning = true;
                startBarcodeDetection();
                
                showStatus('success', 'Kamera Aktif', 'Arahkan QR code ke kamera untuk scan otomatis');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                const placeholder = document.getElementById('cameraPlaceholder');
                const scanningIndicator = document.getElementById('scanningIndicator');
                
                placeholder.classList.remove('hidden');
                scanningIndicator.classList.add('hidden');
                
                if (error.name === 'NotAllowedError') {
                    showStatus('error', 'Akses Kamera Ditolak', 'Silakan izinkan akses kamera untuk menggunakan scanner');
                } else if (error.name === 'NotFoundError') {
                    showStatus('error', 'Kamera Tidak Ditemukan', 'Tidak ada kamera yang tersedia di perangkat ini');
                } else {
                    showStatus('error', 'Error Kamera', 'Tidak dapat mengakses kamera: ' + error.message);
                }
            }
        }

        function stopCamera() {
            isScanning = false;
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            const videoElement = document.getElementById('cameraVideo');
            const placeholder = document.getElementById('cameraPlaceholder');
            const scanningIndicator = document.getElementById('scanningIndicator');
            const startBtn = document.getElementById('startCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            
            videoElement.classList.add('hidden');
            placeholder.classList.remove('hidden');
            scanningIndicator.classList.add('hidden');
            
            // Hide canvas
            const canvas = document.getElementById('scannerCanvas');
            canvas.classList.add('hidden');
            
            // Update button states
            startBtn.disabled = false;
            startBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            startBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            stopBtn.disabled = true;
            stopBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            stopBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            
            showStatus('success', 'Kamera Dimatikan', 'Scanner barcode telah dihentikan');
        }

        function startBarcodeDetection() {
            if (!isScanning || !currentStream) return;
            
            const videoElement = document.getElementById('cameraVideo');
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            // Show canvas for debugging
            canvas.classList.remove('hidden');
            
            function detectQRCode() {
                if (!isScanning || !videoElement.videoWidth || !videoElement.videoHeight) {
                    if (isScanning) {
                        setTimeout(detectQRCode, 100);
                    }
                    return;
                }
                
                try {
                    // Set canvas size to match video
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    
                    // Draw current video frame to canvas
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // Get image data for QR code detection
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Use jsQR to detect QR codes
                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (qrCode && qrCode.data) {
                        // Draw detection box for visual feedback
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(
                            qrCode.location.topLeftCorner.x,
                            qrCode.location.topLeftCorner.y,
                            qrCode.location.bottomRightCorner.x - qrCode.location.topLeftCorner.x,
                            qrCode.location.bottomRightCorner.y - qrCode.location.topLeftCorner.y
                        );
                        
                        // QR Code detected!
                        processBarcodeResult(qrCode.data);
                        return;
                    }
                        
                } catch (error) {
                    console.error('Error during QR code detection:', error);
                }
                
                // Continue scanning with faster interval
                if (isScanning) {
                    setTimeout(detectQRCode, 100); // Scan every 100ms for faster detection
                }
            }
            
            // Start detection loop
            setTimeout(detectQRCode, 100);
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
            
            // Update day name in schedule header
            const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const dayName = dayNames[now.getDay()];
            document.getElementById('dayName').textContent = dayName;
        }

        function renderSchedule() {
            const tbody = document.getElementById('scheduleTable');
            tbody.innerHTML = '';
            
            if (selectedClass === 'all') {
                // Group by class when showing all
                const classSections = {};
                schedule.forEach(item => {
                    if (!classSections[item.classId]) {
                        classSections[item.classId] = [];
                    }
                    classSections[item.classId].push(item);
                });
                
                // Render each class section
                Object.keys(classSections).forEach((classId, index) => {
                    const className = classes[classId];
                    const classItems = classSections[classId];
                    
                    // Add class header
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'bg-blue-50 border-b-2 border-blue-200';
                    headerRow.innerHTML = `
                        <td colspan="5" class="py-4 px-4 text-lg font-bold text-blue-900 text-center">
                            <div class="flex items-center justify-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 7h10M7 11h10M7 15h10"></path>
                                </svg>
                                KELAS ${className}
                                <span class="ml-3 text-sm bg-blue-200 text-blue-800 px-3 py-1 rounded-full">${classItems.length} Jadwal</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(headerRow);
                    
                    // Add class schedule items
                    classItems.forEach(item => {
                        const teacher = teachers[item.teacherId];
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-100 hover:bg-gray-50';
                        
                        let statusBadge = getStatusBadge(item.status);
                        
                        row.innerHTML = `
                            <td class="py-3 px-4 text-sm text-gray-900 pl-8">${item.time}</td>
                            <td class="py-3 px-4 text-sm font-medium text-gray-900">${teacher.name}</td>
                            <td class="py-3 px-4 text-sm text-gray-600">${teacher.subject}</td>
                            <td class="py-3 px-4 text-sm text-gray-600">${className}</td>
                            <td class="py-3 px-4">${statusBadge}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    // Add spacing between classes (except last)
                    if (index < Object.keys(classSections).length - 1) {
                        const spacerRow = document.createElement('tr');
                        spacerRow.innerHTML = '<td colspan="5" class="py-2"></td>';
                        tbody.appendChild(spacerRow);
                    }
                });
            } else {
                // Single class view
                schedule.forEach(item => {
                    const teacher = teachers[item.teacherId];
                    const className = classes[item.classId];
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    
                    let statusBadge = getStatusBadge(item.status);
                    
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm text-gray-900">${item.time}</td>
                        <td class="py-3 px-4 text-sm font-medium text-gray-900">${teacher.name}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${teacher.subject}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${className}</td>
                        <td class="py-3 px-4">${statusBadge}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        }
        
        function getStatusBadge(status) {
            switch(status) {
                case 'hadir':
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><span class="status-indicator status-hadir"></span>Sedang Mengajar</span>';
                case 'keluar':
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><span class="status-indicator bg-blue-500"></span>Selesai</span>';
                case 'terlambat':
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><span class="status-indicator status-keluar"></span>Terlambat</span>';
                case 'tidak-hadir':
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><span class="status-indicator status-tidak-hadir"></span>Tidak Hadir</span>';
                default:
                    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><span class="status-indicator bg-gray-400"></span>Belum Dimulai</span>';
            }
        }



        function processBarcodeResult(barcode) {
            // Stop scanning temporarily to prevent multiple scans
            const wasScanning = isScanning;
            isScanning = false;
            
            // Process the barcode
            processBarcodeData(barcode);
            
            // Resume scanning after a short delay
            setTimeout(() => {
                if (wasScanning && currentStream) {
                    isScanning = true;
                    startBarcodeDetection();
                }
            }, 2000);
        }

        function processManualBarcode() {
            const input = document.getElementById('barcodeInput');
            const barcode = input.value.trim();
            
            if (!barcode) {
                showStatus('error', 'Kode QR tidak boleh kosong', 'Silakan scan atau ketik kode QR');
                return;
            }
            
            processBarcodeData(barcode);
            input.value = '';
            input.focus();
        }

        function processBarcodeData(barcode) {
            if (!barcode) {
                showStatus('error', 'Kode QR tidak boleh kosong', 'Silakan scan atau ketik kode QR');
                return;
            }
            
            // Show scanned code notification first
            showCodeNotification(barcode);
            
            // QR code is now class name (e.g., "X1", "XI1", "XII1")
            const scannedClassName = barcode.trim().toUpperCase();
            
            // Find class ID from class name
            let scannedClassId = null;
            for (const [classId, className] of Object.entries(classes)) {
                if (className === scannedClassName) {
                    scannedClassId = classId;
                    break;
                }
            }
            
            if (!scannedClassId) {
                showStatus('error', 'Kelas tidak ditemukan', `Kelas "${scannedClassName}" tidak terdaftar dalam sistem`);
                return;
            }
            
            // Since we don't know which teacher is scanning, we need to ask or detect
            // For demo purposes, let's show a teacher selection dialog
            showTeacherSelectionDialog(scannedClassId, scannedClassName);
        }
        
        function showTeacherSelectionDialog(scannedClassId, scannedClassName) {
            // Stop camera when showing teacher selection
            stopCamera();
            
            // Create modal for teacher selection
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pilih Nama Guru</h3>
                    <p class="text-sm text-gray-600 mb-4">QR Code kelas <strong>${scannedClassName}</strong> berhasil di-scan. Pilih nama Anda:</p>
                    <div class="space-y-2 mb-4" id="teacherList">
                        ${Object.entries(teachers).map(([teacherId, teacher]) => `
                            <button onclick="processTeacherAttendance('${teacherId}', '${scannedClassId}', '${scannedClassName}')" 
                                    class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-colors">
                                <div class="font-medium text-gray-900">${teacher.name}</div>
                                <div class="text-sm text-gray-600">${teacher.subject}</div>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="closeTeacherDialog()" 
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">
                        Batal
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function closeTeacherDialog() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
            
            // Reset to initial state when canceling
            setTimeout(() => {
                resetToInitialState();
            }, 500);
        }
        
        function processTeacherAttendance(teacherId, scannedClassId, scannedClassName) {
            closeTeacherDialog();
            
            const teacher = teachers[teacherId];
            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5);
            
            // Check if teacher has schedule in the scanned class
            const scheduleItem = allSchedule.find(s => s.teacherId === teacherId && s.classId === scannedClassId);
            
            if (scheduleItem) {
                // Teacher has schedule in this class - process attendance
                if (!scheduleItem.checkIn) {
                    // Check-in
                    scheduleItem.checkIn = currentTime;
                    scheduleItem.status = 'hadir';
                    
                    showStatus('success', `${teacher.name} berhasil masuk kelas`, `Kelas ${scannedClassName} - ${currentTime}`);
                } else if (!scheduleItem.checkOut) {
                    // Check-out
                    scheduleItem.checkOut = currentTime;
                    scheduleItem.status = 'keluar';
                    
                    showStatus('success', `${teacher.name} berhasil keluar kelas`, `Kelas ${scannedClassName} - ${currentTime}`);
                } else {
                    showStatus('warning', 'Sudah tercatat lengkap', `${teacher.name} sudah melakukan check-in dan check-out untuk kelas ${scannedClassName}`);
                }
                
                renderSchedule();
                
                // Reset to initial state after successful attendance
                setTimeout(() => {
                    resetToInitialState();
                }, 3000);
                
            } else {
                // Teacher doesn't have schedule in this class - show where they should be
                const teacherSchedules = allSchedule.filter(s => s.teacherId === teacherId);
                
                if (teacherSchedules.length === 0) {
                    showStatus('error', 'Tidak ada jadwal hari ini', `${teacher.name} tidak memiliki jadwal mengajar hari ini`);
                } else {
                    // Show where teacher should be teaching
                    const currentSchedules = teacherSchedules.filter(s => {
                        const [startTime] = s.time.split('-');
                        const [endTime] = s.time.split('-')[1];
                        return currentTime >= startTime && currentTime <= endTime;
                    });
                    
                    if (currentSchedules.length > 0) {
                        const correctClass = classes[currentSchedules[0].classId];
                        showWrongClassDialog(teacher, scannedClassName, correctClass, currentSchedules[0]);
                    } else {
                        // Show all teacher's schedules for today
                        showTeacherScheduleDialog(teacher, teacherSchedules, scannedClassName);
                    }
                }
            }
        }
        
        function showWrongClassDialog(teacher, scannedClass, correctClass, schedule) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                            <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Kelas Salah!</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            <strong>${teacher.name}</strong> sedang berada di kelas <strong>${scannedClass}</strong>, 
                            tetapi seharusnya mengajar di:
                        </p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="text-lg font-bold text-blue-900">KELAS ${correctClass}</div>
                            <div class="text-sm text-blue-700">${schedule.time}</div>
                            <div class="text-sm text-blue-600">${teacher.subject}</div>
                        </div>
                        <p class="text-xs text-gray-500">Silakan menuju ke kelas yang benar dan scan QR code di sana.</p>
                    </div>
                    <button onclick="closeWrongClassDialog()" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                        Mengerti
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function showTeacherScheduleDialog(teacher, schedules, scannedClass) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="text-center mb-4">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Tidak Ada Jadwal di Kelas ${scannedClass}</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            <strong>${teacher.name}</strong> tidak memiliki jadwal mengajar di kelas <strong>${scannedClass}</strong> hari ini.
                        </p>
                        <div class="text-left">
                            <h4 class="font-semibold text-gray-900 mb-2">Jadwal Anda hari ini:</h4>
                            <div class="space-y-2">
                                ${schedules.map(schedule => `
                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                        <div class="font-medium text-gray-900">Kelas ${classes[schedule.classId]}</div>
                                        <div class="text-sm text-gray-600">${schedule.time}</div>
                                        <div class="text-sm text-gray-500">${teacher.subject}</div>
                                        <div class="text-xs ${schedule.status === 'hadir' ? 'text-green-600' : schedule.status === 'terlambat' ? 'text-yellow-600' : schedule.status === 'tidak-hadir' ? 'text-red-600' : 'text-gray-500'}">
                                            ${schedule.status === 'hadir' ? ' Sudah hadir' : schedule.status === 'terlambat' ? ' Terlambat' : schedule.status === 'tidak-hadir' ? ' Tidak hadir' : 'Belum dimulai'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <button onclick="closeWrongClassDialog()" 
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                        Tutup
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function closeWrongClassDialog() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
            
            // Reset to initial state after closing dialog
            setTimeout(() => {
                resetToInitialState();
            }, 500);
        }
        
        function resetToInitialState() {
            // Clear barcode input
            const barcodeInput = document.getElementById('barcodeInput');
            barcodeInput.value = '';
            barcodeInput.focus();
            
            // Hide status display
            const statusDiv = document.getElementById('scanStatus');
            statusDiv.classList.add('hidden');
            
            // Reset class selector to "all"
            const classSelector = document.getElementById('classSelector');
            classSelector.value = 'all';
            selectedClass = 'all';
            schedule = allSchedule;
            
            // Re-render schedule
            renderSchedule();
            
            // Show ready message
            showStatus('success', 'Siap untuk scan berikutnya', 'Silakan scan QR code atau aktifkan kamera untuk melanjutkan');
        }

        function showCodeNotification(barcode) {
            // Create notification popup
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-lg z-50 fade-in';
            notification.style.zIndex = '9999';
            
            const scannedClassName = barcode.trim().toUpperCase();
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="font-semibold">QR Code Terdeteksi!</p>
                        <p class="text-sm opacity-90">Kelas: ${scannedClassName}</p>
                        <p class="text-sm opacity-90">Memproses absensi...</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function showStatus(type, title, detail) {
            const statusDiv = document.getElementById('scanStatus');
            const indicator = document.getElementById('statusIndicator');
            const titleEl = document.getElementById('statusText');
            const detailEl = document.getElementById('statusDetail');
            
            statusDiv.className = 'mt-4 p-4 rounded-lg fade-in';
            
            switch(type) {
                case 'success':
                    statusDiv.classList.add('bg-green-50', 'border', 'border-green-200');
                    indicator.className = 'status-indicator status-hadir';
                    titleEl.className = 'font-medium text-green-800';
                    detailEl.className = 'text-sm text-green-600 mt-1';
                    break;
                case 'warning':
                    statusDiv.classList.add('bg-yellow-50', 'border', 'border-yellow-200');
                    indicator.className = 'status-indicator status-keluar';
                    titleEl.className = 'font-medium text-yellow-800';
                    detailEl.className = 'text-sm text-yellow-600 mt-1';
                    break;
                case 'error':
                    statusDiv.classList.add('bg-red-50', 'border', 'border-red-200');
                    indicator.className = 'status-indicator status-tidak-hadir';
                    titleEl.className = 'font-medium text-red-800';
                    detailEl.className = 'text-sm text-red-600 mt-1';
                    break;
            }
            
            titleEl.textContent = title;
            detailEl.textContent = detail;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // Add demo QR codes to console for testing
        console.log('=== DEMO QR CODES UNTUK TESTING ===');
        console.log('QR Code sekarang adalah nama kelas. Coba scan atau ketik:');
        console.log('');
        console.log(' KELAS YANG ADA JADWAL HARI INI:');
        console.log('- X1   (untuk kelas X1)');
        console.log('- XI1  (untuk kelas XI1)');
        console.log('- XII1 (untuk kelas XII1)');
        console.log('');
        console.log(' KELAS YANG TIDAK ADA JADWAL:');
        console.log('- X2, X3, X4, X5, X6, X7, X8');
        console.log('- XI2, XI3, XI4, XI5, XI6, XI7, XI8');
        console.log('- XII2, XII3, XII4, XII5, XII6, XII7, XII8');
        console.log('');
        console.log(' CARA TESTING:');
        console.log('1. Ketik "X1" di input manual atau scan QR code "X1"');
        console.log('2. Pilih nama guru dari daftar');
        console.log('3. Jika guru ada jadwal di kelas tersebut = berhasil absen');
        console.log('4. Jika guru tidak ada jadwal = tampil jadwal yang benar');
        console.log('');
        console.log(' CONTOH TESTING:');
        console.log('- Scan "X1"  Pilih "Bambang Irwandi"  Berhasil (ada jadwal)');
        console.log('- Scan "X2"  Pilih guru manapun  Error (kelas tidak terdaftar)');
        console.log('- Scan "XI1"  Pilih "Wardani"  Salah kelas (seharusnya di XII1)');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a3eb8b45f38802',t:'MTc1NzA1NjM2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
